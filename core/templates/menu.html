{# core/templates/menu.html #}
{% extends "index.html" %}
{% block title %}{{ restaurant.name }} Menu{% endblock %}

{% block content %}
  <h1 class="mb-4">{{ restaurant.name }}</h1>
  <p class="mb-4">{{ restaurant.description }}</p>

  <div class="row">
    {% for item in menu_items %}
      <div class="col-md-4 mb-3">
        <div class="card h-100">
          {% if item.image_url %}
            <img src="{{ item.image_url }}"
                 class="card-img-top"
                 alt="{{ item.name }}"
                 style="object-fit:cover;height:200px;">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ item.name }}</h5>
            <p class="card-text">{{ item.description|default:"No description" }}</p>
            <p class="card-text mt-auto"><strong>â‚ª{{ item.price }}</strong></p>

            <div class="d-flex align-items-center mt-2">
              <input
                type="number"
                class="form-control me-2 quantity-input"
                data-item-id="{{ item.id }}"
                value="1"
                min="1"
                style="width: 80px;"
              >
              <button
                class="btn btn-primary add-to-cart-btn"
                data-item-id="{{ item.id }}"
              >
                Add to Cart
              </button>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No menu items found for this restaurant.</p>
    {% endfor %}
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
// helper to read CSRF token
function getCookie(name) {
  let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

document.addEventListener('DOMContentLoaded', function() {
  // attach click handlers to each add-to-cart button
  document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const itemId = btn.dataset.itemId;
      const qtyInput = document.querySelector(
        `.quantity-input[data-item-id="${itemId}"]`
      );
      const quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

      const csrftoken = getCookie('csrftoken');
      const formData = new FormData();
      formData.append('item_id', itemId);
      formData.append('quantity', quantity);

      fetch("{% url 'core:add_to_cart' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData,
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          const badge = document.getElementById('cart-count');
          if (badge) badge.textContent = data.cartCount;
        } else {
          alert('Could not add to cart.');
        }
      })
      .catch(() => alert('Error adding to cart.'));
    });
  });
});
</script>
{% endblock %}
